<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸</title>
  <style>
    body { margin:0; padding:0; background:#000; color:#fff;
      font-family:"Microsoft JhengHei"; text-align:center}
    h1{margin:24px 0;color:gold;}
    button{padding:12px 24px;margin:12px auto;display:block;
      background:#28a745;border:none;color:#fff;border-radius:8px;cursor:pointer;}
    .card{background:#222;margin:12px auto;padding:16px;
      border-radius:8px;max-width:360px;text-align:left;}
    .card p{margin:4px 0;color:#fff;font-size:0.9rem}
    .card button{margin-top:8px;padding:8px;display:block;width:100%;
      border:none;border-radius:6px;background:#009688;color:#fff;cursor:pointer;}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸</h1>
  <button id="start">ç™»å…¥ä¸¦æŸ¥è©¢</button>
  <div id="list"></div>

  <script>
    const LIFF_ID = '2007161529-B4X1z4xl';  // æ–°çš„æŸ¥è©¢ LIFF ID
    const API     = 'https://script.google.com/macros/s/AKfycbxhnSh3KEr4R0d5gHvOUsUAX16BI2xTfpVjKjc_c--9W4IetOKFZ2dHIl5QfeSCllHq/exec';

    let USER_ID;

    async function initLIFF() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) return liff.login();
      const prof = await liff.getProfile();
      USER_ID = prof.userId;
      queryCoupons();
    }

    async function queryCoupons() {
      const res  = await fetch(`${API}?action=query&userId=${USER_ID}`);
      const list = await res.json();
      render(list);
    }

    function render(list) {
      const c = document.getElementById('list');
      if (!list.length) {
        c.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯æ ¸éŠ·çš„å„ªæƒ </p>';
        return;
      }
      c.innerHTML = '';
      list.forEach(it => {
        const t = it.time ? new Date(it.time).toLocaleString() : 'æœªæ ¸éŠ·';
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <p>åˆ†åº—ï¼š${it.storeId}</p>
          <p>æŒæœ‰äººï¼š${it.username}</p>
          <p>å» å•†ï¼š${it.vendor}</p>
          <p>å„ªæƒ ï¼š${it.prize}</p>
          <p>ç‹€æ…‹ï¼š${t}</p>
          ${!it.time ? '<button>æ ¸éŠ·</button>' : ''}
        `;
        if (!it.time) {
          card.querySelector('button').onclick = () => redeem(it.storeId);
        }
        c.appendChild(card);
      });
    }

    async function redeem(storeId) {
      await fetch(API, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          action: 'claim',
          storeId,
          userId: USER_ID,
          phone: ''
        })
      });
      queryCoupons();
    }

    document.getElementById('start').onclick = initLIFF;
  </script>
</body>
</html>
