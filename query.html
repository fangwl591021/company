<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>🔍 我的優惠</title>
  <style>
    body {
      margin:0; padding:0;
      background:#000; color:#fff;
      font-family:"Microsoft JhengHei";
      text-align:center;
    }
    #container {
      max-width:360px; margin:0 auto; padding:16px;
    }
    h1 { color:gold; margin-bottom:16px; }
    button {
      width:100%; padding:12px; margin:12px 0;
      border:none; border-radius:8px;
      font-size:1rem; cursor:pointer;
    }
    #queryBtn { background:#28a745; color:#fff; }
    .coupon {
      background:#222; padding:12px; margin:8px 0;
      border-radius:8px; text-align:left;
    }
    .coupon p { margin:6px 0; }
    .redeem-btn {
      display:block; width:100%;
      background:#009688; color:#fff;
      padding:10px; margin-top:8px;
      border:none; border-radius:6px;
      font-size:1rem; cursor:pointer;
    }
    .redeemed {
      background:#555; color:#ccc;
      padding:10px; margin:8px 0;
      border-radius:6px;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="container">
    <h1>🔍 我的優惠</h1>
    <button id="queryBtn" disabled>載入中…</button>
    <div id="list"></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcn0dQq4Fl9-gfAs7P10ZMCMeE8h2RJbmuAJ_flUH2a-Shw9nAsaYT9dHViG_De7pU/exec';
    const storeId = new URL(location).searchParams.get('storeId');
    let USER_ID;

    async function init(){
      await liff.init({ liffId:'2007161529-oEeAzNVO' });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      const profile = await liff.getProfile();
      USER_ID = profile.userId;
      const btn = document.getElementById('queryBtn');
      btn.disabled = false;
      btn.textContent = '查詢我的優惠';
      btn.onclick = fetchList;
    }

    async function fetchList(){
      const res = await fetch(`${SCRIPT_URL}?action=query&storeId=${storeId}&userId=${USER_ID}`);
      const { unredeemed, redeemed } = await res.json();
      const container = document.getElementById('list');
      container.innerHTML = '';

      // 先顯示已核銷
      if(redeemed.length){
        const header = document.createElement('div');
        header.className = 'redeemed';
        header.textContent = '✔ 已核銷優惠';
        container.appendChild(header);
        redeemed.forEach(c=>{
          const d = new Date(c.redeemedAt).toLocaleString();
          const div = document.createElement('div');
          div.className = 'redeemed';
          div.textContent = `${c.vendor}：${c.prize}（${d}）`;
          container.appendChild(div);
        });
      }

      // 再顯示未核銷
      if(!unredeemed.length){
        const no = document.createElement('div');
        no.textContent = '目前沒有可核銷的優惠';
        container.appendChild(no);
      } else {
        unredeemed.forEach((c, i)=>{
          const div = document.createElement('div');
          div.className = 'coupon';
          const lines = [
            `1. 廠商：${c.vendor}`,
            `2. 獎品：${c.prize}`,
            `3. 中獎時間：${new Date(c.time).toLocaleString()}`
          ];
          lines.forEach(txt=>{
            const p = document.createElement('p');
            p.textContent = txt;
            div.appendChild(p);
          });
          const btn = document.createElement('button');
          btn.className = 'redeem-btn';
          btn.textContent = '核銷';
          btn.onclick = ()=>redeem(c);
          div.appendChild(btn);
          container.appendChild(div);
        });
      }
    }

    async function redeem(coupon){
      // 傳 prize + drawTime 讓後端 match
      await fetch(SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'text/plain'},
        body: JSON.stringify({
          action:'redeem',
          storeId:storeId,
          userId:USER_ID,
          prize: coupon.prize,
          time:  coupon.time
        })
      });
      // 核銷後重新抓一次
      fetchList();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
