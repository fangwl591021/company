<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸</title>
  <style>
    html, body {
      margin:0; padding:0;
      background:#000; color:#fff;
      font-family:"Microsoft JhengHei",sans-serif;
      text-align:center;
    }
    #container {
      max-width:360px; margin:0 auto; padding:16px;
    }
    h1 {
      margin-bottom:16px; color:gold; font-size:1.8rem;
    }
    button {
      width:100%; max-width:360px;
      padding:12px; margin:12px 0;
      border:none; border-radius:8px;
      font-size:1rem; cursor:pointer;
    }
    #loginBtn { background:#00c300; color:#fff; display:none; }
    #queryBtn { background:#28a745; color:#fff; display:none; }
    .coupon, .redeemed {
      background:#222; text-align:left;
      padding:12px; margin:8px 0;
      border-radius:8px;
    }
    .redeem-btn {
      display:block;
      width:100%; margin-top:8px;
      padding:10px; border:none; border-radius:6px;
      background:#009688; color:#fff;
      font-size:1rem; cursor:pointer;
    }
    .redeemed {
      background:#555; color:#ccc;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="container">
    <h1>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸</h1>
    <button id="loginBtn">LINE ç™»å…¥</button>
    <button id="queryBtn">æŸ¥è©¢æˆ‘çš„å„ªæƒ </button>
    <div id="list"></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcn0dQq4Fl9-gfAs7P10ZMCMeE8h2RJbmuAJ_flUH2a-Shw9nAsaYT9dHViG_De7pU/exec';
    const storeId = new URL(location).searchParams.get('storeId');
    let USER_ID;

    // 1. åˆå§‹ï¼šå…ˆæ‹¿ LIFF IDï¼Œç„¶å¾Œ init
    async function init() {
      // æ‹¿ admin éƒ¨ç½²å¾Œçš„ getLiffId æ¥å£
      const resp = await fetch(`${SCRIPT_URL}?action=getLiffId&storeId=${storeId}`);
      const { liffId } = await resp.json();
      if (!liffId) return alert('æ‰¾ä¸åˆ°åº—å®¶ LIFF IDï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
      await liff.init({ liffId });
      // 2. å¦‚æœæ²’ç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•
      if (!liff.isLoggedIn()) {
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('loginBtn').onclick = () => liff.login();
        return;
      }
      // 3. å·²ç™»å…¥ï¼Œå„²å­˜ userIdï¼Œé¡¯ç¤ºã€ŒæŸ¥è©¢ã€æŒ‰éˆ•
      const profile = await liff.getProfile();
      USER_ID = profile.userId;
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('queryBtn').style.display = 'block';
      document.getElementById('queryBtn').onclick = fetchList;
    }

    // 4. æŸ¥è©¢ä¸¦æ¸²æŸ“
    async function fetchList() {
      const res = await fetch(`${SCRIPT_URL}?action=query&storeId=${storeId}&userId=${USER_ID}`);
      const { unredeemed, redeemed } = await res.json();
      const list = document.getElementById('list');
      list.innerHTML = '';

      // å·²æ ¸éŠ·
      if (redeemed.length) {
        redeemed.forEach(c => {
          const d = new Date(c.redeemedAt).toLocaleString();
          const div = document.createElement('div');
          div.className = 'redeemed';
          div.innerHTML = `
            <strong>${c.vendor}ï¼š${c.prize}</strong><br>
            å·²æ ¸éŠ·æ–¼ï¼š${d}
          `;
          list.appendChild(div);
        });
      }

      // æœªæ ¸éŠ·
      if (!unredeemed.length) {
        const none = document.createElement('div');
        none.textContent = 'ç›®å‰æ²’æœ‰å¯æ ¸éŠ·çš„å„ªæƒ ';
        list.appendChild(none);
      } else {
        unredeemed.forEach(c => {
          const d = new Date(c.time).toLocaleString();
          const div = document.createElement('div');
          div.className = 'coupon';
          div.innerHTML = `
            1. ä½¿ç”¨è€…ï¼š${c.username}<br>
            2. å» å•†ï¼š${c.vendor}<br>
            3. çå“ï¼š${c.prize}<br>
            4. ä¸­çæ™‚é–“ï¼š${d}
          `;
          const btn = document.createElement('button');
          btn.className = 'redeem-btn';
          btn.textContent = 'æ ¸éŠ·';
          btn.onclick = () => redeem(c);
          div.appendChild(btn);
          list.appendChild(div);
        });
      }
    }

    // 5. æ ¸éŠ·ï¼šå‘¼å«åç«¯redeemï¼Œå¸¦ prize/time
    async function redeem(c) {
      await fetch(SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'text/plain'},
        body: JSON.stringify({
          action:'redeem',
          storeId:storeId,
          userId:USER_ID,
          prize:c.prize,
          time: c.time
        })
      });
      // åˆ·æ–°åˆ—è¡¨
      fetchList();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
