<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>🔍 我的優惠券</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      font-family: "Microsoft JhengHei", sans-serif;
      text-align: center;
    }
    #container {
      max-width: 360px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      margin-bottom: 16px;
      color: gold;
      font-size: 1.8rem;
    }
    button {
      width: 100%; max-width: 360px;
      padding: 12px; margin: 12px 0;
      border: none; border-radius: 8px;
      font-size: 1rem; cursor: pointer;
    }
    #loginBtn { background: #00c300; color: #fff; display: none; }
    #queryBtn { background: #28a745; color: #fff; display: none; }
    .coupon, .redeemed {
      background: #222; text-align: left;
      padding: 12px; margin: 8px 0;
      border-radius: 8px;
    }
    .redeem-btn {
      display: block;
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #009688;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    .redeemed {
      background: #555; color: #ccc;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="container">
    <h1>🔍 我的優惠券</h1>
    <button id="loginBtn">LINE 登入</button>
    <button id="queryBtn">查詢我的優惠</button>
    <div id="list"></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcn0dQq4Fl9-gfAs7P10ZMCMeE8h2RJbmuAJ_flUH2a-Shw9nAsaYT9dHViG_De7pU/exec';
    const storeId    = new URL(location).searchParams.get('storeId');
    let USER_ID;

    async function init() {
      // 取得 LIFF ID 並 init
      const resp = await fetch(`${SCRIPT_URL}?action=getLiffId&storeId=${storeId}`);
      const { liffId } = await resp.json();
      if (!liffId) return alert('找不到此店家 LIFF ID');
      await liff.init({ liffId });

      if (!liff.isLoggedIn()) {
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('loginBtn').onclick = () => liff.login();
      } else {
        const profile = await liff.getProfile();
        USER_ID = profile.userId;
        document.getElementById('queryBtn').style.display = 'block';
        document.getElementById('queryBtn').onclick = fetchList;
      }
    }

    async function fetchList() {
      const res = await fetch(`${SCRIPT_URL}?action=query&storeId=${storeId}&userId=${USER_ID}`);
      const { unredeemed, redeemed } = await res.json();
      const list = document.getElementById('list');
      list.innerHTML = '';

      // 已核銷
      redeemed.forEach(c => {
        const d = new Date(c.redeemedAt).toLocaleString();
        const div = document.createElement('div');
        div.className = 'redeemed';
        div.innerHTML = `
          <strong>${c.vendor}：${c.prize}</strong><br>
          已核銷於：${d}
        `;
        list.appendChild(div);
      });

      // 未核銷
      if (!unredeemed.length) {
        const none = document.createElement('div');
        none.textContent = '目前沒有可核銷的優惠';
        list.appendChild(none);
      } else {
        unredeemed.forEach(c => {
          const d = new Date(c.time).toLocaleString();
          const div = document.createElement('div');
          div.className = 'coupon';
          div.innerHTML = `
            1. 使用者：${c.username}<br>
            2. 廠商：${c.vendor}<br>
            3. 獎品：${c.prize}<br>
            4. 中獎時間：${d}
          `;
          const btn = document.createElement('button');
          btn.className = 'redeem-btn';
          btn.textContent = '核銷';
          btn.onclick = () => redeem(c);
          div.appendChild(btn);
          list.appendChild(div);
        });
      }
    }

    async function redeem(coupon) {
      await fetch(SCRIPT_URL, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action:  'redeem',
          storeId: storeId,
          userId:  USER_ID,
          prize:   coupon.prize,
          time:    coupon.time
        })
      });
      fetchList();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
