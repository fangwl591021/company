<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸ï¼ˆJSONP ç‰ˆï¼‰</title>
  <style>
    body { margin:0; padding:0; background:#000; color:#fff;
      font-family:"Microsoft JhengHei"; text-align:center;}
    h1{margin:24px 0; color:gold;}
    button{padding:12px 24px;margin:12px auto;display:block;
      background:#28a745;border:none;color:#fff;border-radius:8px;cursor:pointer;}
    .card{background:#222;margin:12px auto;padding:16px;
      border-radius:8px;max-width:360px;text-align:left;}
    .card p{margin:4px 0;color:#fff;font-size:0.9rem}
    .card button{margin-top:8px;padding:8px;display:block;width:100%;
      border:none;border-radius:6px;background:#009688;color:#fff;cursor:pointer;}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸</h1>
  <button id="start">ç™»å…¥ & æŸ¥è©¢å„ªæƒ åˆ¸</button>
  <div id="list"></div>

  <script>
    // è¯·æ›¿æ¢æˆä½ çš„ Apps Script URL
    const API = 'https://script.google.com/macros/s/AKfycbzzFMCs4J79zh1AdanFffAe3Ezenony3I2pDsWv2OGO5XR9pWyDyfWOF77CMOjbPaLQ/exec';
    let USER_ID;

    // JSONP å›è°ƒï¼šåˆå§‹åŒ– LIFFï¼Œç„¶åæŸ¥è¯¢
    function initLiff(resp) {
      const liffId = resp.liffId;
      if (!liffId) return alert('æ‰¾ä¸åˆ° LIFF ID');
      liff.init({ liffId }).then(() => {
        if (!liff.isLoggedIn()) return liff.login();
        return liff.getProfile();
      }).then(profile => {
        USER_ID = profile.userId;
        queryCoupons();
      });
    }

    // JSONP å›è°ƒï¼šæ¸²æŸ“ä¼˜æƒ åˆ¸åˆ—è¡¨
    function renderCoupons(data) {
      const container = document.getElementById('list');
      container.innerHTML = '';
      if (!data.length) {
        container.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯æ ¸éŠ·çš„å„ªæƒ </p>';
        return;
      }
      data.forEach(item => {
        const t = item.time ? new Date(item.time).toLocaleString() : 'æœªæ ¸éŠ·';
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <p>åˆ†åº—ï¼š${item.storeId}</p>
          <p>æŒæœ‰äººï¼š${item.username}</p>
          <p>å» å•†ï¼š${item.vendor}</p>
          <p>å„ªæƒ ï¼š${item.prize}</p>
          <p>ç‹€æ…‹ï¼š${t}</p>
          ${!item.time ? '<button>æ ¸éŠ·</button>' : ''}
        `;
        if (!item.time) {
          card.querySelector('button').onclick = () => {
            // å†ç”¨ JSONP è°ƒ claimï¼Œå°±ä¸éœ€è¦ CORS äº†
            const cb = 'afterClaim';
            const script = document.createElement('script');
            script.src = `${API}?action=claim`
                       +`&storeId=${item.storeId}`
                       +`&userId=${USER_ID}`
                       +`&phone=${item.phone||''}`
                       +`&callback=${cb}`;
            document.body.appendChild(script);
          };
        }
        container.appendChild(card);
      });
    }

    // Claim JSONP å›è°ƒï¼šæ ¸é”€ååˆ·æ–°åˆ—è¡¨
    function afterClaim(resp) {
      if (resp.success) queryCoupons();
      else alert('æ ¸éŠ·å¤±æ•—ï¼š' + resp.error);
    }

    // å‘èµ·æŸ¥è¯¢ JSONP
    function queryCoupons() {
      const cb = 'renderCoupons';
      const script = document.createElement('script');
      script.src = `${API}?action=query`
                 +`&userId=${USER_ID}`
                 +`&callback=${cb}`;
      document.body.appendChild(script);
    }

    // ç‚¹å‡»æŒ‰é’®ï¼šå…ˆ GET LIFF IDï¼Œå†èµ° initLiff
    document.getElementById('start').onclick = () => {
      const script = document.createElement('script');
      script.src = `${API}?action=getLiffId&storeId=ADMIN&callback=initLiff`;
      document.body.appendChild(script);
    };
  </script>
</body>
</html>
