<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æˆ‘çš„ä¸­çç´€éŒ„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>ğŸ æˆ‘çš„ä¸­çç´€éŒ„</h2>
  <div id="list">è¼‰å…¥ä¸­â€¦</div>

  <script>
    (async ()=> {
      const STORE_ID = new URL(location).searchParams.get('storeId');
      // 1. å…ˆå¾å¾Œç«¯æ‹¿åˆ°å°æ‡‰ storeId çš„ LIFF ID
      const cfg = await fetch(`https://script.google.com/macros/s/â€¦/exec?action=getLiffId&storeId=${STORE_ID}`)
                     .then(r=>r.json());
      if (!cfg.liffId) {
        document.getElementById('list').textContent = 'æ‰¾ä¸åˆ°æ­¤åº—å®¶';
        return;
      }

      // 2. åˆå§‹åŒ– LIFF
      await liff.init({ liffId: cfg.liffId });

      // 3. æ¸…æ‰ URL ä¸Šå¤šé¤˜çš„ code/state
      history.replaceState(null, '', `/company/query.html?storeId=${STORE_ID}`);

      // 4. ç¢ºä¿ç™»å…¥
      if (!liff.isLoggedIn()) {
        return liff.login();  // ä¹‹å¾Œæœƒè‡ªå‹•é‡å°åˆ°ä¸Šé¢å·²æ¸…å¥½çš„ URL
      }

      const profile = await liff.getProfile();
      const uid     = profile.userId;

      // 5. æŸ¥è©¢ä¸­çç´€éŒ„
      const res = await fetch('https://script.google.com/macros/s/AKfycbwooOk6KjFuQywfjQ5mVxeCu2jAzk3z-NQNDOHV7Q0T1FdUtYCy36gJs7ysoNShbtjh/exec', {
        method: 'POST', mode: 'cors',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'query', storeId: STORE_ID, userId: uid })
      });
      const { data, error } = await res.json();
      if (error) {
        document.getElementById('list').textContent = `éŒ¯èª¤ï¼š${error}`;
      } else if (!data.length) {
        document.getElementById('list').textContent = 'ç›®å‰æ²’æœ‰ä¸­çç´€éŒ„';
      } else {
        document.getElementById('list').innerHTML = data.map(o => `
          <div>
            <strong>${o.username}</strong><br>
            ${o.vendor}ï¼š${o.prize}<br>
            é ˜çæ™‚é–“ï¼š${o.drawTime}
          </div>
        `).join('');
      }
    })();
  </script>
</body>
</html>
