<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>我的中獎紀錄</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>🎁 我的中獎紀錄</h2>
  <div id="list">載入中…</div>

  <script>
    (async ()=> {
      const STORE_ID = new URL(location).searchParams.get('storeId');
      // 1. 先從後端拿到對應 storeId 的 LIFF ID
      const cfg = await fetch(`https://script.google.com/macros/s/…/exec?action=getLiffId&storeId=${STORE_ID}`)
                     .then(r=>r.json());
      if (!cfg.liffId) {
        document.getElementById('list').textContent = '找不到此店家';
        return;
      }

      // 2. 初始化 LIFF
      await liff.init({ liffId: cfg.liffId });

      // 3. 清掉 URL 上多餘的 code/state
      history.replaceState(null, '', `/company/query.html?storeId=${STORE_ID}`);

      // 4. 確保登入
      if (!liff.isLoggedIn()) {
        return liff.login();  // 之後會自動重導到上面已清好的 URL
      }

      const profile = await liff.getProfile();
      const uid     = profile.userId;

      // 5. 查詢中獎紀錄
      const res = await fetch('https://script.google.com/macros/s/AKfycbwooOk6KjFuQywfjQ5mVxeCu2jAzk3z-NQNDOHV7Q0T1FdUtYCy36gJs7ysoNShbtjh/exec', {
        method: 'POST', mode: 'cors',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'query', storeId: STORE_ID, userId: uid })
      });
      const { data, error } = await res.json();
      if (error) {
        document.getElementById('list').textContent = `錯誤：${error}`;
      } else if (!data.length) {
        document.getElementById('list').textContent = '目前沒有中獎紀錄';
      } else {
        document.getElementById('list').innerHTML = data.map(o => `
          <div>
            <strong>${o.username}</strong><br>
            ${o.vendor}：${o.prize}<br>
            領獎時間：${o.drawTime}
          </div>
        `).join('');
      }
    })();
  </script>
</body>
</html>
