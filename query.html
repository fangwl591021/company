<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸</title>
  <style>
    html,body{margin:0;padding:0;background:#000;color:#fff;
      font-family:"Microsoft JhengHei";text-align:center}
    #c{max-width:360px;margin:0 auto;padding:16px}
    h1{margin-bottom:16px;color:gold;font-size:1.8rem}
    button{width:100%;max-width:360px;padding:12px;margin:12px 0;
      border:none;border-radius:8px;font-size:1rem;cursor:pointer}
    #loginBtn{background:#00c300;color:#fff;display:none}
    #queryBtn{background:#28a745;color:#fff;display:none}
    .coupon,.redeemed{background:#222;text-align:left;
      padding:12px;margin:8px 0;border-radius:8px}
    .redeem-btn{display:block;width:100%;margin-top:8px;
      padding:10px;border:none;border-radius:6px;
      background:#009688;color:#fff;font-size:1rem;cursor:pointer}
    .redeemed{background:#555;color:#ccc}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="c">
    <h1>ğŸ” æˆ‘çš„å„ªæƒ åˆ¸</h1>
    <button id="loginBtn">LINE ç™»å…¥</button>
    <button id="queryBtn">æŸ¥è©¢æˆ‘çš„å„ªæƒ </button>
    <div id="list"></div>
  </div>
  <script>
    const API    = 'https://script.google.com/macros/s/AKfycby5OO9A0NQ_4c-5scc_KGSi1XqVRrr4YMe2rQE1kUO6_bwlNZES0irr8ENKFgXPi7y5/exec';
    const storeId= new URL(location).searchParams.get('storeId');
    let USER_ID;

    async function init(){
      const r = await fetch(`${API}?action=getLiffId&storeId=${storeId}`);
      const { liffId } = await r.json();
      if(!liffId) return alert('åº—å®¶LIFF IDä¸å­˜åœ¨');
      await liff.init({ liffId });
      if(!liff.isLoggedIn()){
        document.getElementById('loginBtn').style.display='block';
        document.getElementById('loginBtn').onclick=()=>liff.login();
      } else {
        const p = await liff.getProfile();
        USER_ID = p.userId;
        document.getElementById('queryBtn').style.display='block';
        document.getElementById('queryBtn').onclick=fetchList;
      }
    }

    async function fetchList(){
      const r = await fetch(
        `${API}?action=query&storeId=${storeId}&userId=${USER_ID}`
      );
      const { unredeemed, redeemed } = await r.json();
      const list = document.getElementById('list');
      list.innerHTML='';

      // å·²æ ¸éŠ·
      redeemed.forEach(c=>{
        const d = new Date(c.redeemedAt).toLocaleString();
        const div = document.createElement('div');
        div.className='redeemed';
        div.innerHTML=`${c.vendor}ï¼š${c.prize}<br>å·²æ ¸éŠ·æ–¼ï¼š${d}`;
        list.appendChild(div);
      });

      // æœªæ ¸éŠ·
      if(!unredeemed.length){
        const none = document.createElement('div');
        none.textContent='ç›®å‰æ²’æœ‰å¯æ ¸éŠ·çš„å„ªæƒ ';
        list.appendChild(none);
      } else {
        unredeemed.forEach(c=>{
          const d = new Date(c.time).toLocaleString();
          const div=document.createElement('div');
          div.className='coupon';
          div.innerHTML=`
            ä½¿ç”¨è€…ï¼š${c.username}<br>
            å» å•†ï¼š${c.vendor}<br>
            çå“ï¼š${c.prize}<br>
            ä¸­çæ™‚é–“ï¼š${d}
          `;
          const btn=document.createElement('button');
          btn.className='redeem-btn';
          btn.textContent='æ ¸éŠ·';
          btn.onclick=()=>redeem(c);
          div.appendChild(btn);
          list.appendChild(div);
        });
      }
    }

    async function redeem(c){
      await fetch(API,{
        method:'POST',mode:'no-cors',
        headers:{'Content-Type':'text/plain'},
        body:JSON.stringify({
          action:'redeem',
          storeId,
          userId:USER_ID,
          prize:c.prize,
          time:c.time
        })
      });
      fetchList();
    }

    window.addEventListener('DOMContentLoaded',init);
  </script>
</body>
</html>
