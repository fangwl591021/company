<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ” æˆ‘çš„å„ªæƒ </title>
  <style>
    body {
      margin:0; padding:0;
      background:#000; color:#fff;
      font-family:"Microsoft JhengHei";
      text-align:center;
    }
    #container {
      max-width:360px; margin:0 auto; padding:16px;
    }
    h1 { color:gold; margin-bottom:16px; }
    button {
      width:100%; padding:12px; margin:12px 0;
      border:none; border-radius:8px;
      font-size:1rem; cursor:pointer;
    }
    #queryBtn { background:#28a745; color:#fff; }
    .coupon {
      background:#222; padding:12px; margin:8px 0;
      border-radius:8px; text-align:left;
    }
    .coupon p { margin:6px 0; }
    .redeem-btn {
      display:block; width:100%;
      background:#009688; color:#fff;
      padding:10px; margin-top:8px;
      border:none; border-radius:6px;
      font-size:1rem; cursor:pointer;
    }
    .redeemed {
      background:#555; color:#ccc;
      padding:10px; margin:8px 0;
      border-radius:6px;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="container">
    <h1>ğŸ” æˆ‘çš„å„ªæƒ </h1>
    <button id="queryBtn" disabled>è¼‰å…¥ä¸­â€¦</button>
    <div id="list"></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcn0dQq4Fl9-gfAs7P10ZMCMeE8h2RJbmuAJ_flUH2a-Shw9nAsaYT9dHViG_De7pU/exec';
    const storeId = new URL(location).searchParams.get('storeId');
    let USER_ID;

    async function init(){
      await liff.init({ liffId:'2007161529-oEeAzNVO' });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      const profile = await liff.getProfile();
      USER_ID = profile.userId;
      const btn = document.getElementById('queryBtn');
      btn.disabled = false;
      btn.textContent = 'æŸ¥è©¢æˆ‘çš„å„ªæƒ ';
      btn.onclick = fetchList;
    }

    async function fetchList(){
      const res = await fetch(`${SCRIPT_URL}?action=query&storeId=${storeId}&userId=${USER_ID}`);
      const { unredeemed, redeemed } = await res.json();
      const container = document.getElementById('list');
      container.innerHTML = '';

      // å…ˆé¡¯ç¤ºå·²æ ¸éŠ·
      if(redeemed.length){
        const header = document.createElement('div');
        header.className = 'redeemed';
        header.textContent = 'âœ” å·²æ ¸éŠ·å„ªæƒ ';
        container.appendChild(header);
        redeemed.forEach(c=>{
          const d = new Date(c.redeemedAt).toLocaleString();
          const div = document.createElement('div');
          div.className = 'redeemed';
          div.textContent = `${c.vendor}ï¼š${c.prize}ï¼ˆ${d}ï¼‰`;
          container.appendChild(div);
        });
      }

      // å†é¡¯ç¤ºæœªæ ¸éŠ·
      if(!unredeemed.length){
        const no = document.createElement('div');
        no.textContent = 'ç›®å‰æ²’æœ‰å¯æ ¸éŠ·çš„å„ªæƒ ';
        container.appendChild(no);
      } else {
        unredeemed.forEach((c, i)=>{
          const div = document.createElement('div');
          div.className = 'coupon';
          const lines = [
            `1. å» å•†ï¼š${c.vendor}`,
            `2. çå“ï¼š${c.prize}`,
            `3. ä¸­çæ™‚é–“ï¼š${new Date(c.time).toLocaleString()}`
          ];
          lines.forEach(txt=>{
            const p = document.createElement('p');
            p.textContent = txt;
            div.appendChild(p);
          });
          const btn = document.createElement('button');
          btn.className = 'redeem-btn';
          btn.textContent = 'æ ¸éŠ·';
          btn.onclick = ()=>redeem(c);
          div.appendChild(btn);
          container.appendChild(div);
        });
      }
    }

    async function redeem(coupon){
      // å‚³ prize + drawTime è®“å¾Œç«¯ match
      await fetch(SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'text/plain'},
        body: JSON.stringify({
          action:'redeem',
          storeId:storeId,
          userId:USER_ID,
          prize: coupon.prize,
          time:  coupon.time
        })
      });
      // æ ¸éŠ·å¾Œé‡æ–°æŠ“ä¸€æ¬¡
      fetchList();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
