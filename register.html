<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>店家註冊申請</title>
  <!-- 相對路徑載入 CSS -->
  <link rel="stylesheet" href="/company/static/css/style.css" />
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background:#000; color:#fff; text-align:center; font-family:"Microsoft JhengHei"; margin:0; padding:0; }
    h1 { color:gold; margin:24px 0; }
    select, input, button { width:80%; max-width:320px; margin:12px auto; display:block; padding:10px; font-size:1em; border:none; border-radius:6px; }
    select, input { background:#222; color:#fff; }
    button { background:#28a745; color:#fff; cursor:pointer; }
    #msg { margin:16px 0; font-size:1.2em; }
  </style>
</head>
<body>
  <h1>店家註冊申請</h1>
  <button id="loginBtn" style="display:none">LINE 登入</button>
  <div id="form" style="display:none">
    <select id="storeSelect">
      <option value="">選擇店鋪</option>
    </select>
    <input id="name" placeholder="姓名" />
    <input id="phone" placeholder="電話" />
    <button id="submitBtn">送出註冊申請</button>
  </div>
  <div id="pending" style="display:none">
    <h2>待審核列表</h2>
    <ul id="pendingList"></ul>
  </div>
  <div id="msg"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyTOG8pmKsnQ-mrxhZ2Ny-JaZasBfshyJ0S9fBDf2H7Wkd8VKHHQCTmm0tcGBf4f1BA/exec';
    let USER_ID;

    async function init() {
      // 先取得管理界面專用 LIFF ID (設定 storeId 為 ADMIN)
      const resp = await fetch(`${SCRIPT_URL}?action=getLiffId&storeId=ADMIN`);
      const { liffId } = await resp.json();
      if (!liffId) return alert('缺少管理 LIFF ID，請聯絡系統管理員');
      await liff.init({ 1656871455-vE1ZZLJ7 }); // 確保 liffId 是從後端取得的管理 LIFF ID，storeId=ADMIN

      // 登入流程
      if (!liff.isLoggedIn()) {
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('loginBtn').onclick = () => liff.login();
        return;
      }
      document.getElementById('loginBtn').style.display = 'none';

      const profile = await liff.getProfile();
      USER_ID = profile.userId;

      // 載入所有店鋪選項
      const stores = await fetch(`${SCRIPT_URL}?action=listStores`).then(r => r.json());
      const sel = document.getElementById('storeSelect');
      stores.forEach(s => {
        const o = document.createElement('option');
        o.value = s.id;
        o.textContent = `${s.id} ${s.name}`;
        sel.appendChild(o);
      });
      document.getElementById('form').style.display = 'block';

      // 如果是管理員，載入待審核列表
      if (['Udb7c5578b402bf6f1e0f7065fc57c17b','Uee955167d0b18f84a66906b550c9b292'].includes(USER_ID)) {
        loadPending();
      }
    }

    async function submitRequest() {
      const sid = document.getElementById('storeSelect').value;
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if (!sid || !name || !phone) return alert('請填完整');
      await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'registerRequest', storeId: sid, userId: USER_ID, name, phone })
      });
      document.getElementById('msg').textContent = '申請已送出，請等待核准';
    }

    async function loadPending() {
      const list = await fetch(`${SCRIPT_URL}?action=listRequests`).then(r => r.json());
      const ul = document.getElementById('pendingList'); ul.innerHTML = '';
      list.forEach(req => {
        const li = document.createElement('li');
        li.textContent = `${req.storeId} ${req.name} (${req.phone}) `;
        const btn = document.createElement('button');
        btn.textContent = '核准';
        btn.onclick = () => approve(req.storeId, req.userId);
        li.appendChild(btn);
        ul.appendChild(li);
      });
      document.getElementById('pending').style.display = 'block';
    }

    async function approve(storeId, userId) {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'approve', storeId, userId })
      });
      loadPending();
    }

    document.getElementById('submitBtn').onclick = submitRequest;
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
