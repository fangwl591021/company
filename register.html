<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>店家註冊申請</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      background: #000;
      color: #fff;
      text-align: center;
      font-family: "Microsoft JhengHei";
      margin: 0;
      padding: 0;
    }
    h1 {
      color: gold;
      margin: 24px 0;
    }
    input, button {
      width: 80%;
      max-width: 320px;
      margin: 12px auto;
      display: block;
      padding: 10px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
    }
    input {
      background: #222;
      color: #fff;
    }
    button {
      background: #28a745;
      color: #fff;
      cursor: pointer;
    }
    #msg {
      margin: 16px 0;
      font-size: 1.1em;
      color: #ccc;
    }
    #pending button {
      width: auto;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h1>店家註冊申請</h1>
  <button id="loginBtn" style="display:none">LINE 登入</button>

  <div id="form" style="display:none">
    <input id="storeName" placeholder="店家名稱">
    <input id="name" placeholder="姓名">
    <input id="phone" placeholder="電話">
    <button id="submitBtn">送出註冊申請</button>
    <button id="viewPendingBtn" style="display:none; margin-top:8px;">查看待審核列表</button>
  </div>

  <div id="pending" style="display:none;">
    <h2>待審核列表</h2>
    <ul id="pendingList"></ul>
  </div>

  <div id="msg"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/你的WebApp網址/exec';
    const ADMINS = ['Udb7c5578b402bf6f1e0f7065fc57c17b', 'Uee955167d0b18f84a66906b550c9b292'];
    let USER_ID = '';

    async function init() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getLiffId&storeId=ADMIN`);
        let { liffId } = await res.json();
        if (!liffId) {
          console.warn('未回傳 LIFF ID，使用預設');
          liffId = '2007161529-w3nJZpm0';
        }

        await liff.init({ liffId });

        if (!liff.isLoggedIn()) {
          document.getElementById('loginBtn').style.display = 'block';
          document.getElementById('loginBtn').onclick = () => liff.login();
          return;
        }

        const profile = await liff.getProfile();
        USER_ID = profile.userId;
        document.getElementById('msg').textContent = '你的 USER_ID 是：' + USER_ID;

        document.getElementById('form').style.display = 'block';
        const isAdmin = ADMINS.includes(USER_ID);

        if (isAdmin) {
          document.getElementById('viewPendingBtn').style.display = 'block';
          document.getElementById('pending').style.display = 'block';
          document.getElementById('viewPendingBtn').onclick = loadPending;
          loadPending();
        } else {
          document.getElementById('viewPendingBtn').style.display = 'none';
          document.getElementById('pending').style.display = 'none';
        }

      } catch (err) {
        alert('⚠️ 發生錯誤：' + err.message);
      }
    }

    async function submitRequest() {
      const storeName = document.getElementById('storeName').value.trim();
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if (!storeName || !name || !phone) return alert('請填寫所有欄位');

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'registerRequest',
          storeId: storeName,
          userId: USER_ID,
          name,
          phone
        })
      }).then(r => r.json());

      document.getElementById('msg').textContent = res.success
        ? '✅ 申請已送出，請等待核准'
        : `❌ 錯誤：${res.error}`;

      if (res.success) {
        document.getElementById('storeName').value = '';
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
      }

      if (ADMINS.includes(USER_ID)) loadPending();
    }

    async function loadPending() {
      const list = await fetch(`${SCRIPT_URL}?action=listRequests`).then(r => r.json());
      const ul = document.getElementById('pendingList');
      ul.innerHTML = '';

      list.forEach(req => {
        const li = document.createElement('li');
        li.textContent = `${req.storeId}｜${req.name}（${req.phone}）`;
        const btn = document.createElement('button');
        btn.textContent = '核准';
        btn.onclick = () => approve(req.storeId, req.userId);
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    async function approve(storeId, userId) {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'approve',
          storeId,
          userId
        })
      }).then(r => r.json());

      if (res.success) {
        alert('✅ 已核准成功');
        loadPending();
      } else {
        alert('❌ 核准失敗：' + res.error);
      }
    }

    document.getElementById('submitBtn').onclick = submitRequest;
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
