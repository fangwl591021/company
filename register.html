<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>店家註冊申請</title>
  <link rel="stylesheet" href="static/css/style.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" defer></script>
  <style>
    body { background:#000; color:#fff; text-align:center; font-family:"Microsoft JhengHei"; margin:0; padding:0; }
    h1 { color:gold; margin:24px 0; }
    input, button { width:80%; max-width:320px; margin:12px auto; display:block; padding:10px; font-size:1em; border:none; border-radius:6px; }
    input { background:#222; color:#fff; }
    button { background:#28a745; color:#fff; cursor:pointer; }
    #msg { margin:16px 0; font-size:1.2em; }
    #pending button { width:auto; margin-left:8px; }
  </style>
</head>
<body>
  <h1>店家註冊申請</h1>
  <button id="loginBtn" style="display:none">LINE 登入</button>
  <div id="form" style="display:none">
    <input id="storeName" placeholder="店家名稱">
    <input id="name" placeholder="姓名">
    <input id="phone" placeholder="電話">
    <button id="submitBtn">送出註冊申請</button>
    <button id="viewPendingBtn" style="display:none; margin-top:8px;">查看待審核列表</button>
  </div>
  <div id="pending" style="display:none">
    <h2>待審核列表</h2>
    <ul id="pendingList"></ul>
  </div>
  <div id="msg"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFUt-3GbVTW50Jhb6YTeZhZrgfHMGutTMIx-TcBgeUjpBjRgSLmaUib0fuZOkohwbN/exec';
    const ADMINS = ['Udb7c5578b402bf6f1e0f7065fc57c17b','Uee955167d0b18f84a66906b550c9b292'];
    let USER_ID = '';

    async function init() {
      try {
        // 取得 LIFF ID
        const resp = await fetch(`${SCRIPT_URL}?action=getLiffId&storeId=ADMIN`);
        let { liffId } = await resp.json();
        if (!liffId) {
          console.warn('後端未回傳 ADMIN LIFF ID，使用預設值');
          liffId = '2007161529-w3nJZpm0';
        }
        await liff.init({ liffId });

        // 登入檢查
        if (!liff.isLoggedIn()) {
          document.getElementById('loginBtn').style.display = 'block';
          document.getElementById('loginBtn').onclick = () => liff.login();
          return;
        }

        // 登入後顯示表單
        const profile = await liff.getProfile();
        USER_ID = profile.userId;
        document.getElementById('form').style.display = 'block';

        // 管理員功能
        if (ADMINS.includes(USER_ID)) {
          const viewBtn = document.getElementById('viewPendingBtn');
          viewBtn.style.display = 'block';
          viewBtn.onclick = loadPending;
          loadPending(); // 自動載入待審核
        }

        // 使用者狀態檢查
        checkStatus();
      } catch (err) {
        console.error('LIFF 初始化失敗', err);
        document.getElementById('msg').textContent = 'LIFF 初始化失敗';
      }
    }

    async function checkStatus() {
      const res = await fetch(`${SCRIPT_URL}?action=listRequests`);
      const list = await res.json();
      const me = list.find(r => r.userId === USER_ID);

      if (me) {
        const approved = me.approved === true || me.approved === 'TRUE';
        const expire = me.expireDate || me.到期日 || '';
        const now = new Date();
        const expired = expire ? new Date(expire) < now : false;

        if (!approved) {
          document.getElementById('msg').textContent = '⏳ 資料已送出，等待審核中';
        } else if (expired) {
          document.getElementById('msg').textContent = '⚠️ 使用期限已過，請重新申請';
        } else {
          document.getElementById('msg').textContent = '✅ 已審核通過，歡迎使用';
        }
      }
    }

    async function submitRequest() {
      const storeName = documen
