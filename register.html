<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“‹ åº—å®¶å“¡å·¥è¨»å†Š</title>
  <link rel="stylesheet" href="static/css/style.css" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background:#000; color:#fff; text-align:center; font-family:"Microsoft JhengHei"; margin:0; padding:0; }
    h1 { color:gold; margin:24px 0; }
    select, input, button { width:80%; max-width:320px; margin:12px auto; display:block; padding:10px; font-size:1em; border:none; border-radius:6px; }
    select, input { background:#222; color:#fff; }
    button { background:#28a745; color:#fff; cursor:pointer; }
    #msg { margin:16px 0; font-size:1.2em; }
  </style>
</head>
<body>
  <h1>å“¡å·¥è¨»å†Š & æ ¸å‡†</h1>
  <button id="loginBtn">LINE ç™»å…¥</button>
  <div id="form" style="display:none">
    <select id="storeSelect">
      <option value="">é¸æ“‡åº—é‹ª</option>
    </select>
    <input id="name" placeholder="å§“å" />
    <input id="phone" placeholder="é›»è©±" />
    <button id="submitBtn">é€å‡ºè¨»å†Šç”³è«‹</button>
  </div>
  <div id="pending" style="display:none">
    <h2>å¾…å¯©æ ¸åˆ—è¡¨</h2>
    <ul id="pendingList"></ul>
  </div>
  <div id="msg"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyTOG8pmKsnQ-mrxhZ2Ny-JaZasBfshyJ0S9fBDf2H7Wkd8VKHHQCTmm0tcGBf4f1BA/exec';
    let USER_ID;

    async function init() {
      const resLiff = await fetch(`${SCRIPT_URL}?action=getLiffId&storeId=ADMIN`);
      const liffId = (await resLiff.json()).liffId;
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) {
        document.getElementById('loginBtn').onclick = () => liff.login();
        return;
      }
      document.getElementById('loginBtn').style.display = 'none';
      USER_ID = (await liff.getProfile()).userId;
      loadStores();
      if (await isAdmin(USER_ID)) loadPending();
      document.getElementById('form').style.display = 'block';
    }

    async function loadStores() {
      const stores = await fetch(`${SCRIPT_URL}?action=listStores`).then(r => r.json());
      const sel = document.getElementById('storeSelect');
      stores.forEach(s => {
        const o = document.createElement('option');
        o.value = s.id;
        o.textContent = `${s.id} ${s.name}`;
        sel.appendChild(o);
      });
    }

    async function submitRequest() {
      const sid = document.getElementById('storeSelect').value;
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if (!sid || !name || !phone) return alert('è«‹å¡«å®Œæ•´');
      await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'registerRequest', storeId: sid, userId: USER_ID, name, phone })
      });
      document.getElementById('msg').textContent = 'ç”³è«‹å·²é€å‡ºï¼Œè«‹ç­‰å¾…æ ¸å‡†';
    }

    async function loadPending() {
      const list = await fetch(`${SCRIPT_URL}?action=listRequests`).then(r => r.json());
      const ul = document.getElementById('pendingList'); ul.innerHTML = '';
      list.forEach(req => {
        const li = document.createElement('li');
        li.textContent = `${req.storeId} ${req.name} (${req.phone}) `;
        const btn = document.createElement('button');
        btn.textContent = 'æ ¸å‡†';
        btn.onclick = () => approve(req.storeId, req.userId);
        li.appendChild(btn);
        ul.appendChild(li);
      });
      document.getElementById('pending').style.display = 'block';
    }

    async function approve(storeId, userId) {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'approve', storeId, userId })
      });
      loadPending();
    }

    async function isAdmin(userId) {
      // ç®¡ç†å“¡ ID åˆ—è¡¨
      const admins = ['Udb7c5578b402bf6f1e0f7065fc57c17b', 'Uee955167d0b18f84a66906b550c9b292'];
      return admins.includes(userId);
    }

    document.getElementById('submitBtn').onclick = submitRequest;
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
